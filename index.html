function updateHeatmap() {
    if (!historicalData) return;

    const ctx = document.getElementById('riskHeatmapChart').getContext('2d');

    // Extract data
    const dates = historicalData.dates;
    const prices = historicalData.prices;
    const risks = historicalData.risks; // Use pre-calculated risk from the backend

    // Destroy previous chart if it exists
    if (heatmapChart) {
        heatmapChart.destroy();
    }

    // Function to generate a color based on risk level
    function getRiskColor(risk) {
        // Map risk (0 to 1) to a color gradient from dark blue to dark red
        const hue = (1 - risk) * 240; // Hue ranges from 240 (blue) to 0 (red)
        return `hsl(${hue}, 100%, 50%)`; // Use HSL for smooth color transition
    }

    // Create the scatter plot
    heatmapChart = new Chart(ctx, {
        type: 'scatter', // Use scatter plot for dots
        data: {
            labels: dates,
            datasets: [{
                label: 'Price',
                data: prices.map((price, index) => ({
                    x: new Date(dates[index]), // X-axis: Date
                    y: price, // Y-axis: Price
                })),
                backgroundColor: risks.map(risk => getRiskColor(risk)), // Color based on risk
                borderColor: 'rgba(0, 0, 0, 0.2)', // Border color for dots
                borderWidth: 1,
                pointRadius: 5, // Size of dots
                pointHoverRadius: 7, // Size of dots on hover
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM d',
                        }
                    },
                    grid: {
                        display: false,
                    },
                    title: {
                        display: true,
                        text: 'Date',
                    }
                },
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Price (USD)',
                    }
                }
            },
            plugins: {
                legend: {
                    display: false,
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const price = context.raw.y;
                            const risk = risks[context.dataIndex];
                            return `Price: $${price.toFixed(6)} | Risk: ${(risk * 100).toFixed(2)}%`;
                        }
                    }
                }
            }
        }
    });

    // Clear any existing risk keys
    const existingRiskKey = document.querySelector('.risk-key');
    if (existingRiskKey) {
        existingRiskKey.remove();
    }

    // Add risk key to the chart
    const riskKey = document.createElement('div');
    riskKey.className = 'risk-key';
    riskKey.innerHTML = `
        <div style="position: absolute; right: 20px; top: 20px; background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 4px;">
            <strong>Risk Key:</strong>
            <div style="display: flex; align-items: center; margin-top: 5px;">
                <div style="width: 20px; height: 20px; background: ${getRiskColor(0)}; margin-right: 5px;"></div>
                <span>Low Risk (Buy)</span>
            </div>
            <div style="display: flex; align-items: center; margin-top: 5px;">
                <div style="width: 20px; height: 20px; background: ${getRiskColor(0.5)}; margin-right: 5px;"></div>
                <span>Medium Risk</span>
            </div>
            <div style="display: flex; align-items: center; margin-top: 5px;">
                <div style="width: 20px; height: 20px; background: ${getRiskColor(1)}; margin-right: 5px;"></div>
                <span>High Risk (Sell)</span>
            </div>
        </div>
    `;
    document.querySelector('.chart-container').appendChild(riskKey);
}
