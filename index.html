<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Market Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-title { color: #666; font-size: 14px; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: bold; }
        #chartContainer { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 500px; }
        .fg-neutral { color: #666; }
        .fg-fear { color: #4CAF50; }
        .fg-greed { color: #FF5722; }
        .fg-extreme { color: #E91E63; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Kaspa Market Dashboard</h1>
            <p>Last updated: <span id="lastUpdated">-</span></p>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-title">Price (USD)</div>
                <div class="metric-value" id="price">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Market Cap</div>
                <div class="metric-value" id="marketCap">-</div>
            </div>
            <div class="metric-card" id="fearGreedCard">
                <div class="metric-title">Fear & Greed Index</div>
                <div class="metric-value">
                    <span id="fgValue">-</span> 
                    <span id="fgText" style="font-size: 16px;"></span>
                </div>
            </div>
        </div>

        <div id="chartContainer">
            <canvas id="marketChart"></canvas>
        </div>
    </div>

    <script>
        let chart;
        
        async function initChart() {
            const ctx = document.getElementById('marketChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Kaspa Price',
                        data: [],
                        borderColor: '#2196F3',
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Fear & Greed Index',
                        data: [],
                        borderColor: '#FF9800',
                        yAxisID: 'y2',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' } },
                        y: { position: 'left', title: { text: 'Price (USD)', display: true } },
                        y2: { 
                            position: 'right', 
                            title: { text: 'Fear & Greed Index', display: true },
                            min: 0,
                            max: 100
                        }
                    },
                    interaction: { mode: 'index' }
                }
            });
            
            updateChartData();
        }

        async function updateChartData() {
            try {
                const response = await fetch('/data/history');
                const data = await response.json();
                
                // Update price data
                chart.data.datasets[0].data = data.kaspa.price_history?.map(p => ({
                    x: new Date(p.timestamp),
                    y: p.value
                })) || [];
                
                // Update F&G data
                chart.data.datasets[1].data = data.fear_greed?.map(fg => ({
                    x: new Date(fg.timestamp),
                    y: fg.value
                })) || [];
                
                chart.update();
            } catch (error) {
                console.error('Chart update error:', error);
            }
        }

        async function updateMetrics() {
            try {
                const response = await fetch('/data/latest');
                const data = await response.json();
                
                // Update basic metrics
                document.getElementById('price').textContent = `$${data.price?.toFixed(4) || '-'}`;
                document.getElementById('marketCap').textContent = `$${(data.market_cap / 1e6).toFixed(1)}M`;
                document.getElementById('lastUpdated').textContent = 
                    new Date(data.last_updated).toLocaleString();
                
                // Update Fear & Greed
                const fg = data.fear_greed;
                if (fg) {
                    document.getElementById('fgValue').textContent = fg.value;
                    document.getElementById('fgText').textContent = fg.classification;
                    
                    const card = document.getElementById('fearGreedCard');
                    card.className = 'metric-card ' + (
                        fg.value < 25 ? 'fg-extreme' :
                        fg.value < 45 ? 'fg-fear' :
                        fg.value < 55 ? 'fg-neutral' :
                        fg.value < 75 ? 'fg-greed' : 'fg-extreme'
                    );
                }
                
            } catch (error) {
                console.error('Metrics update error:', error);
            }
        }

        // Initial setup
        initChart();
        updateMetrics();
        setInterval(updateMetrics, 60000);  // Update every minute
        setInterval(updateChartData, 3600000);  // Update chart hourly
    </script>
</body>
</html>
